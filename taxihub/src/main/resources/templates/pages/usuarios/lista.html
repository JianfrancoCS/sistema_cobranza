<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/system :: system(~{::content}, 'Usuarios - TaxiHub', ~{::scripts})}">
<head>
    <title>Lista de Usuarios</title>
</head>
<body>

<div th:fragment="content" class="d-flex flex-column" style="height: 100%; overflow-y: auto;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people me-2"></i>Gestión de Usuarios</h2>
        <a th:href="@{/usuarios/crear}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Usuario
        </a>
    </div>

    <div class="flex-grow-1" style="overflow-y: auto; min-height: 0;">

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
            </h5>
        </div>
        <div class="card-body">
            <form th:action="@{/usuarios}" method="get" class="row g-3">
                <div class="col-md-5">
                    <label for="correo" class="form-label">Correo</label>
                    <input type="text" class="form-control" id="correo" name="correo"
                           th:value="${correoFiltro}" placeholder="Buscar por correo">
                </div>
                <div class="col-md-2">
                    <label for="size" class="form-label">Mostrar</label>
                    <select class="form-select" id="size" name="size">
                        <option value="10" th:selected="${pageSize == 10}">10</option>
                        <option value="25" th:selected="${pageSize == 25}">25</option>
                        <option value="50" th:selected="${pageSize == 50}">50</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="btn-group w-100" role="group">
                        <button type="submit" class="btn btn-primary" style="height: 40px;">
                            <i class="bi bi-search me-1"></i>
                        </button>
                        <a th:href="@{/usuarios}" class="btn btn-outline-secondary" style="height: 40px; display: flex; align-items: center;">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div th:if="${successMessage}"
         th:attr="data-success-message=${successMessage}"
         style="display: none;"></div>
    <div th:if="${errorMessage}"
         th:attr="data-error-message=${errorMessage}"
         style="display: none;"></div>

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="bi bi-table me-2"></i>Lista de Usuarios
                <span class="text-muted ms-2">(<span th:text="${totalElements}">0</span> registros)</span>
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Usuario</th>
                            <th scope="col">Empleado</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Grupo</th>
                            <th scope="col">Fecha Creación</th>
                            <th scope="col" style="width: 120px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="usuario : ${usuarios}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <img th:if="${usuario.empleado != null && usuario.empleado.persona != null && usuario.empleado.persona.imagenBase64 != null}"
                                         th:src="'data:' + ${usuario.empleado.persona.imagenTipo ?: 'image/jpeg'} + ';base64,' + ${usuario.empleado.persona.imagenBase64}"
                                         alt="Avatar" 
                                         class="rounded-circle me-3"
                                         style="width: 40px; height: 40px; object-fit: cover;">
                                    <div th:unless="${usuario.empleado != null && usuario.empleado.persona != null && usuario.empleado.persona.imagenBase64 != null}"
                                         class="bg-secondary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3"
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-person text-secondary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-medium" th:text="${usuario.correo}">usuario@email.com</div>
                                        <small class="text-muted">ID: [[${usuario.id}]]</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span th:if="${usuario.empleado != null}" 
                                      th:text="${usuario.empleado.persona.numeroDocumento}">
                                    12345678
                                </span>
                                <span th:unless="${usuario.empleado != null}" class="text-muted">Sin empleado</span>
                            </td>
                            <td>
                                <span th:if="${usuario.activo}" class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i>Activo
                                </span>
                                <span th:unless="${usuario.activo}" class="badge bg-danger">
                                    <i class="bi bi-x-circle me-1"></i>Inactivo
                                </span>
                                <div th:if="${usuario.contrasenaTemporal}" class="mt-1">
                                    <small class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Contraseña temporal
                                    </small>
                                </div>
                            </td>
                            <td>
                                <span th:if="${!usuario.grupos.empty}" 
                                      class="badge bg-secondary" 
                                      th:text="${usuario.grupos.iterator().next().nombreGrupo}">
                                    ADMINISTRADOR
                                </span>
                                <span th:if="${usuario.grupos.empty}" class="text-muted">Sin grupo</span>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(usuario.fechaCreacion, 'dd/MM/yyyy')}">01/01/2024</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a th:href="@{/usuarios/editar/{id}(id=${usuario.id})}" 
                                       class="btn btn-sm btn-outline-primary"
                                       title="Editar usuario">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="confirmDelete(this)" 
                                            th:data-id="${usuario.id}"
                                            th:data-type="usuarios" 
                                            th:data-name="${usuario.correo}"
                                            title="Eliminar usuario">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(usuarios)}">
                            <td colspan="6" class="text-center py-4">
                                <i class="bi bi-inbox display-6 text-muted"></i>
                                <p class="text-muted mt-2 mb-0">No se encontraron usuarios</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div th:if="${totalPages > 1}" class="card-footer">
            <nav aria-label="Paginación de usuarios">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/usuarios(page=0, size=${pageSize}, correo=${correoFiltro})}"
                           aria-label="Primera">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/usuarios(page=${currentPage - 1}, size=${pageSize}, correo=${correoFiltro})}"
                           aria-label="Anterior">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    
                    <li th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, currentPage - 2), T(java.lang.Math).min(totalPages - 1, currentPage + 2))}"
                        class="page-item" 
                        th:classappend="${pageNum == currentPage} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/usuarios(page=${pageNum}, size=${pageSize}, correo=${correoFiltro})}"
                           th:text="${pageNum + 1}">1</a>
                    </li>
                    
                    <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/usuarios(page=${currentPage + 1}, size=${pageSize}, correo=${correoFiltro})}"
                           aria-label="Siguiente">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    
                    <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                        <a class="page-link" 
                           th:href="@{/usuarios(page=${totalPages - 1}, size=${pageSize}, correo=${correoFiltro})}"
                           aria-label="Última">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="text-center mt-2">
                <small class="text-muted">
                    Mostrando 
                    <span th:text="${currentPage * pageSize + 1}">1</span>
                    -
                    <span th:text="${T(java.lang.Math).min((currentPage + 1) * pageSize, totalElements)}">10</span>
                    de
                    <span th:text="${totalElements}">100</span>
                    usuarios
                </small>
            </div>
        </div>
    </div>
    
    </div>

    <div th:replace="~{fragments/modal-confirm :: simple}"></div>
</div>

<div th:fragment="scripts">
</div>

</body>
</html>